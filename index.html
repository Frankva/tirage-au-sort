<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tirage au sort</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.classless.min.css">
  <script type="importmap">
    {
      "imports": {
        "preact": "https://esm.sh/preact",
        "preact/": "https://esm.sh/preact/",
        "htm": "https://esm.sh/htm"
      }
    }
  </script>
</head>

<body>
  <script type="module">
    import { h, render } from 'preact';
    import { useState, useRef, useEffect } from 'preact/hooks';
    import htm from 'htm';

    const html = htm.bind(h);

    // Composant ThemeSelector
    const ThemeSelector = () => {
      const [theme, setTheme] = useState(() => {
        // V√©rifier le th√®me sauvegard√© ou la pr√©f√©rence syst√®me
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) return savedTheme;
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      });

      // Appliquer le th√®me au body
      useEffect(() => {
        if (theme === 'auto') {
          // Suivre la pr√©f√©rence syst√®me
          const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
          const applySystemTheme = () => {
            document.documentElement.setAttribute('data-theme', mediaQuery.matches ? 'dark' : 'light');
          };

          applySystemTheme();
          mediaQuery.addEventListener('change', applySystemTheme);

          return () => mediaQuery.removeEventListener('change', applySystemTheme);
        } else {
          document.documentElement.setAttribute('data-theme', theme);
        }
      }, [theme]);

      const handleThemeChange = (newTheme) => {
        setTheme(newTheme);
        localStorage.setItem('theme', newTheme);
      };

      return html`
        <nav>
          <select
            value=${theme}
            onChange=${(e) => handleThemeChange(e.target.value)}
          >
            <option value="auto">üåì</option>
            <option value="light">‚òÄÔ∏è</option>
            <option value="dark">üåô</option>
          </select>
        </nav>
      `;
    };

    // Composant Header
    const Header = () => {
      return html`
        <header>
          <nav>
            <ul>
              <li>
                <hgroup>
                  <h1>Tirage au sort</h1>
                  <p>Entrez vos √©l√©ments et laissez le hasard d√©cider</p>
                </hgroup>
              </li>
            </ul>
            <ul>
              <${ThemeSelector} />
            </ul>
          </nav>
        </header>
      `;
    };

    // Composant InputSection
    const InputSection = ({ items, onItemsChange, onDraw, onReset, isDrawing }) => {
      const textareaRef = useRef(null);
      const [textValue, setTextValue] = useState('');

      // Initialiser le textarea avec les items
      useEffect(() => {
        if (textareaRef.current && items.length > 0) {
          const text = items.join('\n');
          setTextValue(text);
          textareaRef.current.value = text;
        }
      }, [items]);

      // G√©rer les changements dans le textarea
      const handleInputChange = () => {
        const text = textareaRef.current.value;
        setTextValue(text);
        
        // Ne mettre √† jour les items que lorsque l'utilisateur a fini de taper (debounce)
        clearTimeout(window.inputTimeout);
        window.inputTimeout = setTimeout(() => {
          const newItems = text.split('\n').filter(item => item.trim() !== '');
          onItemsChange(newItems);
        }, 500);
      };

      // G√©rer la touche Entr√©e pour ajouter une nouvelle ligne
      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const start = e.target.selectionStart;
          const end = e.target.selectionEnd;
          const newValue = textValue.substring(0, start) + '\n' + textValue.substring(end);
          
          setTextValue(newValue);
          textareaRef.current.value = newValue;
          
          // Positionner le curseur apr√®s le saut de ligne
          setTimeout(() => {
            textareaRef.current.selectionStart = textareaRef.current.selectionEnd = start + 1;
          }, 0);
          
          // Mettre √† jour les items apr√®s un court d√©lai
          clearTimeout(window.inputTimeout);
          window.inputTimeout = setTimeout(() => {
            const newItems = newValue.split('\n').filter(item => item.trim() !== '');
            onItemsChange(newItems);
          }, 500);
        }
      };

      return html`
        <section>
          <form>
              <label for="items-list">Entrez un √©l√©ment par ligne :</label>
              <textarea
                id="items-list"
                ref=${textareaRef}
                rows="10"
                placeholder="Pierre\nPaul\nJacques"
                onInput=${handleInputChange}
                onKeyDown=${handleKeyDown}
              ></textarea>

            <button
              type="submit"
              onClick=${onDraw}
              disabled=${isDrawing}
            >
              ${isDrawing ? 'Tirage en cours...' : 'Tirer au sort'}
            </button>

            <input
              type="reset"
              value="Tout effacer"
              onClick=${onReset}
            />
          </form>
        </section>
      `;
    };

    // Composant ResultSection
    const ResultSection = ({ itemsCount, result, onClearResult, hasResult }) => {
      return html`
        <section>
          <article>
            <header>Nombre d'√©l√©ments :</header>
            <p>${itemsCount}</p>
          </article>

          ${result && html`
            <article>
              <h3>R√©sultat du tirage :</h3>
              <p><strong>${result}</strong></p>
            </article>
          `}

          ${hasResult && html`
            <button
              onClick=${onClearResult}
            >
              Effacer le r√©sultat
            </button>
          `}
        </section>
      `;
    };

    // Composant UrlShare
    const UrlShare = ({ shareUrl }) => {
      const [copied, setCopied] = useState(false);

      const copyUrl = () => {
        navigator.clipboard.writeText(shareUrl);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      };

      return html`
        <article>
          <p>URL de partage :</p>
          <input
            type="text"
            value=${shareUrl}
            readonly
          />
          <small>
            Partagez cette URL pour sauvegarder ou partager votre liste
          </small>
          <button
            onClick=${copyUrl}
          >
            ${copied ? 'Copi√© !' : 'Copier'}
          </button>
        </article>
      `;
    };

    // Composant Footer
    const Footer = () => {
      return html`
        <footer>
          <p>Application de tirage au sort - Fonctionne enti√®rement dans votre navigateur</p>
        </footer>
      `;
    };

    // Composant principal App
    const App = () => {
      const [items, setItems] = useState([]);
      const [result, setResult] = useState(null);
      const [isDrawing, setIsDrawing] = useState(false);
      const [initialized, setInitialized] = useState(false);
      const [shareUrl, setShareUrl] = useState(window.location.href);

      // Charger les √©l√©ments depuis l'URL au d√©marrage
      useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const itemsParam = urlParams.get('items');
        
        if (itemsParam) {
          try {
            const decodedItems = decodeURIComponent(itemsParam);
            const newItems = decodedItems.split('\n').filter(item => item.trim() !== '');
            setItems(newItems);
          } catch (e) {
            console.error("Erreur lors du d√©codage des √©l√©ments depuis l'URL", e);
          }
        }
        setInitialized(true);
      }, []);

      // Mettre √† jour l'URL lorsque les √©l√©ments changent
      useEffect(() => {
        if (!initialized) return;

        if (items.length > 0) {
          const encodedItems = encodeURIComponent(items.join('\n'));
          const url = new URL(window.location);
          url.searchParams.set('items', encodedItems);
          window.history.replaceState({}, '', url);
          setShareUrl(url.toString());
        } else {
          const url = new URL(window.location);
          url.searchParams.delete('items');
          window.history.replaceState({}, '', url);
          setShareUrl(url.toString());
        }
      }, [items, initialized]);

      // Mettre √† jour la liste des √©l√©ments
      const handleItemsChange = (newItems) => {
        setItems(newItems);
      };

      // Tirer au sort
      const drawLottery = () => {
        if (items.length === 0) {
          alert('Veuillez entrer au moins un √©l√©ment');
          return;
        }

        setIsDrawing(true);
        setResult(null);

        // Animation de tirage
        let counter = 0;
        const interval = setInterval(() => {
          const randomIndex = Math.floor(Math.random() * items.length);
          setResult(items[randomIndex]);
          counter++;

          if (counter > 20) {
            clearInterval(interval);
            setIsDrawing(false);
          }
        }, 100);
      };

      // R√©initialiser
      const resetAll = () => {
        setItems([]);
        setResult(null);
      };

      // Effacer le r√©sultat
      const clearResult = () => {
        setResult(null);
      };

      return html`
        <main>
          <${Header} />

          <${InputSection}
            items=${items}
            onItemsChange=${handleItemsChange}
            onDraw=${drawLottery}
            onReset=${resetAll}
            isDrawing=${isDrawing}
          />

          <${ResultSection}
            itemsCount=${items.length}
            result=${result}
            onClearResult=${clearResult}
            hasResult=${!!result}
          />

          <${UrlShare} shareUrl=${shareUrl} />

          <${Footer} />
        </main>
      `;
    };

    render(html`<${App} />`, document.body);
  </script>
</body>
</html>
