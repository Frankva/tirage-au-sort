<!DOCTYPE html>
<html lang="fr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tirage au sort</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/reallygoodsoftware/tailwind-lite@759f1d7/dist/tailwind.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
  <script type="importmap">
    {
      "imports": {
        "preact": "https://esm.sh/preact",
        "preact/": "https://esm.sh/preact/",
        "htm": "https://esm.sh/htm"
      }
    }
  </script>
</head>

<body>
  <div id="app"></div>

  <script type="module">
    import { h, render } from 'preact';
    import { useState, useRef, useEffect } from 'preact/hooks';
    import htm from 'htm';

    const html = htm.bind(h);

    // Composant ThemeSelector
    const ThemeSelector = () => {
      const [theme, setTheme] = useState(() => {
        // V√©rifier le th√®me sauvegard√© ou la pr√©f√©rence syst√®me
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) return savedTheme;
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
      });

      // Appliquer le th√®me au body
      useEffect(() => {
        if (theme === 'auto') {
          // Suivre la pr√©f√©rence syst√®me
          const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
          const applySystemTheme = () => {
            document.documentElement.setAttribute('data-theme', mediaQuery.matches ? 'dark' : 'light');
          };

          applySystemTheme();
          mediaQuery.addEventListener('change', applySystemTheme);

          return () => mediaQuery.removeEventListener('change', applySystemTheme);
        } else {
          document.documentElement.setAttribute('data-theme', theme);
        }
      }, [theme]);

      const handleThemeChange = (newTheme) => {
        setTheme(newTheme);
        localStorage.setItem('theme', newTheme);
      };

      return html`
        <div class="theme-selector">
          <select value=${theme} onChange=${(e) => handleThemeChange(e.target.value)}>
            <option value="auto">üåì</option>
            <option value="light">‚òÄÔ∏è</option>
            <option value="dark">üåô</option>
          </select>
        </div>
      `;
    };

    // Composant Header
    const Header = () => {
      return html`
        <header>
          <h1>Tirage au sort</h1>
          <p>Entrez vos √©l√©ments et laissez le hasard d√©cider</p>
        </header>
      `;
    };

    // Composant InputSection
    const InputSection = ({ items, onItemsChange, onDraw, onClearResult, onReset, isDrawing, hasResult }) => {
      const textareaRef = useRef(null);
      const [textValue, setTextValue] = useState('');

      // Initialiser le textarea avec les items
      useEffect(() => {
        if (textareaRef.current && items.length > 0) {
          const text = items.join('\n');
          setTextValue(text);
          textareaRef.current.value = text;
        }
      }, [items]);

      // G√©rer les changements dans le textarea
      const handleInputChange = () => {
        const text = textareaRef.current.value;
        setTextValue(text);
        
        // Ne mettre √† jour les items que lorsque l'utilisateur a fini de taper (debounce)
        clearTimeout(window.inputTimeout);
        window.inputTimeout = setTimeout(() => {
          const newItems = text.split('\n').filter(item => item.trim() !== '');
          onItemsChange(newItems);
        }, 500);
      };

      // G√©rer la touche Entr√©e pour ajouter une nouvelle ligne
      const handleKeyDown = (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          const start = e.target.selectionStart;
          const end = e.target.selectionEnd;
          const newValue = textValue.substring(0, start) + '\n' + textValue.substring(end);
          
          setTextValue(newValue);
          textareaRef.current.value = newValue;
          
          // Positionner le curseur apr√®s le saut de ligne
          setTimeout(() => {
            textareaRef.current.selectionStart = textareaRef.current.selectionEnd = start + 1;
          }, 0);
          
          // Mettre √† jour les items apr√®s un court d√©lai
          clearTimeout(window.inputTimeout);
          window.inputTimeout = setTimeout(() => {
            const newItems = newValue.split('\n').filter(item => item.trim() !== '');
            onItemsChange(newItems);
          }, 500);
        }
      };

      return html`
        <section>
          <div>
            <label for="items-list">Entrez un √©l√©ment par ligne :</label>
            <textarea
              id="items-list"
              ref=${textareaRef}
              rows="10"
              placeholder="Exemple :&#10;Pierre&#10;Paul&#10;Jacques"
              onInput=${handleInputChange}
              onKeyDown=${handleKeyDown}
            ></textarea>
          </div>

          <div>
            <button
              onClick=${onDraw}
              disabled=${isDrawing}
            >
              ${isDrawing ? 'Tirage en cours...' : 'Tirer au sort'}
            </button>

            <button
              onClick=${onClearResult}
              disabled=${!hasResult}
            >
              Effacer le r√©sultat
            </button>

            <button
              onClick=${onReset}
            >
              Tout effacer
            </button>
          </div>
        </section>
      `;
    };

    // Composant ResultSection
    const ResultSection = ({ itemsCount, result }) => {
      return html`
        <section>
          <div>
            <article>
              <header>Nombre d'√©l√©ments :</header>
              <p>${itemsCount}</p>
            </article>

            ${result && html`
              <article>
                <h3>R√©sultat du tirage :</h3>
                <p><strong>${result}</strong></p>
              </article>
            `}
          </div>
        </section>
      `;
    };

    // Composant UrlShare
    const UrlShare = () => {
      const [copied, setCopied] = useState(false);
      
      const copyUrl = () => {
        navigator.clipboard.writeText(window.location.href);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
      };

      return html`
        <div>
          <p>URL de partage :</p>
          <div>
            <input
              type="text"
              value=${window.location.href}
              readonly
            />
            <button
              onClick=${copyUrl}
            >
              ${copied ? 'Copi√© !' : 'Copier'}
            </button>
          </div>
          <small>
            Partagez cette URL pour sauvegarder ou partager votre liste
          </small>
        </div>
      `;
    };

    // Composant Footer
    const Footer = () => {
      return html`
        <footer>
          <p>Application de tirage au sort - Fonctionne enti√®rement dans votre navigateur</p>
        </footer>
      `;
    };

    // Composant principal App
    const App = () => {
      const [items, setItems] = useState([]);
      const [result, setResult] = useState(null);
      const [isDrawing, setIsDrawing] = useState(false);
      const [initialized, setInitialized] = useState(false);

      // Charger les √©l√©ments depuis l'URL au d√©marrage
      useEffect(() => {
        const urlParams = new URLSearchParams(window.location.search);
        const itemsParam = urlParams.get('items');
        
        if (itemsParam) {
          try {
            const decodedItems = decodeURIComponent(itemsParam);
            const newItems = decodedItems.split('\n').filter(item => item.trim() !== '');
            setItems(newItems);
          } catch (e) {
            console.error("Erreur lors du d√©codage des √©l√©ments depuis l'URL", e);
          }
        }
        setInitialized(true);
      }, []);

      // Mettre √† jour l'URL lorsque les √©l√©ments changent
      useEffect(() => {
        if (!initialized) return;
        
        if (items.length > 0) {
          const encodedItems = encodeURIComponent(items.join('\n'));
          const url = new URL(window.location);
          url.searchParams.set('items', encodedItems);
          window.history.replaceState({}, '', url);
        } else {
          const url = new URL(window.location);
          url.searchParams.delete('items');
          window.history.replaceState({}, '', url);
        }
      }, [items, initialized]);

      // Mettre √† jour la liste des √©l√©ments
      const handleItemsChange = (newItems) => {
        setItems(newItems);
      };

      // Tirer au sort
      const drawLottery = () => {
        if (items.length === 0) {
          alert('Veuillez entrer au moins un √©l√©ment');
          return;
        }

        setIsDrawing(true);
        setResult(null);

        // Animation de tirage
        let counter = 0;
        const interval = setInterval(() => {
          const randomIndex = Math.floor(Math.random() * items.length);
          setResult(items[randomIndex]);
          counter++;

          if (counter > 20) {
            clearInterval(interval);
            setIsDrawing(false);
          }
        }, 100);
      };

      // R√©initialiser
      const resetAll = () => {
        setItems([]);
        setResult(null);
      };

      // Effacer le r√©sultat
      const clearResult = () => {
        setResult(null);
      };

      return html`
        <main class="container">
          <${ThemeSelector} />
          <${Header} />

          <${InputSection}
            items=${items}
            onItemsChange=${handleItemsChange}
            onDraw=${drawLottery}
            onClearResult=${clearResult}
            onReset=${resetAll}
            isDrawing=${isDrawing}
            hasResult=${!!result}
          />

          <${ResultSection}
            itemsCount=${items.length}
            result=${result}
          />

          <${UrlShare} />

          <${Footer} />
        </main>
      `;
    };

    render(html`<${App} />`, document.getElementById('app'));
  </script>
</body>
</html>
